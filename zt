#!/bin/bash

# ============================================================
# zt — Zapret Tracker CLI
# Скопировать на сервер: cp zt /usr/local/bin/zt && chmod +x /usr/local/bin/zt
#
# Использование:
#   zt update    — обновить из GitHub и перезапустить
#   zt restart   — просто перезапустить
#   zt stop      — остановить
#   zt start     — запустить
#   zt status    — статус сервиса
#   zt logs      — логи (live)
#   zt logs 50   — последние 50 строк
#   zt backup    — бэкап базы
#   zt env       — редактировать .env
#   zt domain    — настроить DuckDNS + HTTPS (Mini App)
# ============================================================

APP_DIR="/opt/zapret-tracker"
SERVICE="zapret-tracker"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

case "${1}" in

  update|up)
    if [ "$EUID" -ne 0 ]; then
      echo -e "${RED}sudo zt update${NC}"
      exit 1
    fi
    bash "$APP_DIR/update.sh"
    ;;

  restart|rs)
    if [ "$EUID" -ne 0 ]; then
      echo -e "${RED}sudo zt restart${NC}"
      exit 1
    fi
    echo -e "${YELLOW}Перезапуск...${NC}"
    systemctl restart "$SERVICE"
    sleep 1
    if systemctl is-active --quiet "$SERVICE"; then
      echo -e "${GREEN}Работает${NC}"
    else
      echo -e "${RED}Не запустился! Логи:${NC}"
      journalctl -u "$SERVICE" -n 10 --no-pager
    fi
    ;;

  stop)
    if [ "$EUID" -ne 0 ]; then echo -e "${RED}sudo zt stop${NC}"; exit 1; fi
    systemctl stop "$SERVICE"
    echo -e "${YELLOW}Остановлен${NC}"
    ;;

  start)
    if [ "$EUID" -ne 0 ]; then echo -e "${RED}sudo zt start${NC}"; exit 1; fi
    systemctl start "$SERVICE"
    sleep 1
    if systemctl is-active --quiet "$SERVICE"; then
      echo -e "${GREEN}Запущен${NC}"
    else
      echo -e "${RED}Ошибка запуска${NC}"
      journalctl -u "$SERVICE" -n 10 --no-pager
    fi
    ;;

  status|st)
    echo -e "${CYAN}=== Zapret Tracker ===${NC}"
    echo ""
    
    # Service status
    if systemctl is-active --quiet "$SERVICE"; then
      echo -e "  Статус:    ${GREEN}работает${NC}"
    else
      echo -e "  Статус:    ${RED}остановлен${NC}"
    fi

    # Uptime
    UPTIME=$(systemctl show "$SERVICE" --property=ActiveEnterTimestamp --value 2>/dev/null)
    [ -n "$UPTIME" ] && echo -e "  Запущен:   ${UPTIME}"

    # Memory
    PID=$(systemctl show "$SERVICE" --property=MainPID --value 2>/dev/null)
    if [ "$PID" != "0" ] && [ -n "$PID" ]; then
      MEM=$(ps -p "$PID" -o rss= 2>/dev/null | awk '{printf "%.1f MB", $1/1024}')
      echo -e "  Память:    ${MEM}"
    fi

    # DB size
    if [ -f "$APP_DIR/data/tracker.db" ]; then
      DBSIZE=$(du -h "$APP_DIR/data/tracker.db" | cut -f1)
      echo -e "  База:      ${DBSIZE}"
    fi

    # Uploads
    if [ -d "$APP_DIR/uploads" ]; then
      UPSIZE=$(du -sh "$APP_DIR/uploads" 2>/dev/null | cut -f1)
      UPCOUNT=$(find "$APP_DIR/uploads" -type f | wc -l)
      echo -e "  Файлы:     ${UPSIZE} (${UPCOUNT} файлов)"
    fi

    # Bot
    BOT=$(grep BOT_USERNAME "$APP_DIR/.env" 2>/dev/null | cut -d= -f2)
    if [ -n "$BOT" ]; then
      echo -e "  Бот:       ${CYAN}@${BOT}${NC}"
    else
      echo -e "  Бот:       ${YELLOW}не настроен${NC}"
    fi

    echo ""
    ;;

  logs|log)
    LINES="${2:-0}"
    if [ "$LINES" -gt 0 ] 2>/dev/null; then
      journalctl -u "$SERVICE" -n "$LINES" --no-pager
    else
      journalctl -u "$SERVICE" -f
    fi
    ;;

  backup|bak)
    if [ "$EUID" -ne 0 ]; then echo -e "${RED}sudo zt backup${NC}"; exit 1; fi
    if [ -f "$APP_DIR/data/tracker.db" ]; then
      BACKUP="$APP_DIR/data/tracker.db.bak.$(date +%Y%m%d_%H%M%S)"
      cp "$APP_DIR/data/tracker.db" "$BACKUP"
      echo -e "${GREEN}Бэкап: $BACKUP${NC}"
    else
      echo -e "${YELLOW}БД не найдена${NC}"
    fi
    ;;

  env)
    if [ "$EUID" -ne 0 ]; then echo -e "${RED}sudo zt env${NC}"; exit 1; fi
    ${EDITOR:-nano} "$APP_DIR/.env"
    echo ""
    read -p "Перезапустить сервис? [y/N] " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      systemctl restart "$SERVICE"
      sleep 1
      if systemctl is-active --quiet "$SERVICE"; then
        echo -e "${GREEN}Перезапущен${NC}"
      else
        echo -e "${RED}Ошибка!${NC}"
        journalctl -u "$SERVICE" -n 10 --no-pager
      fi
    fi
    ;;

  domain)
    if [ "$EUID" -ne 0 ]; then echo -e "${RED}sudo zt domain${NC}"; exit 1; fi
    if [ -f "$APP_DIR/setup-domain.sh" ]; then
      bash "$APP_DIR/setup-domain.sh"
    else
      echo -e "${RED}Скрипт setup-domain.sh не найден в $APP_DIR${NC}"
    fi
    ;;

  *)
    echo -e "${CYAN}zt${NC} — Zapret Tracker CLI"
    echo ""
    echo -e "  ${GREEN}zt update${NC}     Обновить из GitHub и перезапустить"
    echo -e "  ${GREEN}zt restart${NC}    Перезапустить сервис"
    echo -e "  ${GREEN}zt start${NC}      Запустить"
    echo -e "  ${GREEN}zt stop${NC}       Остановить"
    echo -e "  ${GREEN}zt status${NC}     Статус, память, размер БД"
    echo -e "  ${GREEN}zt logs${NC}       Логи (live)"
    echo -e "  ${GREEN}zt logs 50${NC}    Последние 50 строк лога"
    echo -e "  ${GREEN}zt backup${NC}     Бэкап базы данных"
    echo -e "  ${GREEN}zt env${NC}        Редактировать .env и перезапустить"
    echo -e "  ${GREEN}zt domain${NC}     DuckDNS + HTTPS для Telegram Mini App"
    echo ""
    ;;

esac
